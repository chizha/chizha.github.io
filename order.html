<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>å‡¤å‡°å·æ‰‹å·¥åŠ - åœ¨çº¿ä¸‹å•</title>
    <style>
        /* åŸºç¡€æ ·å¼é‡ç½® */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Helvetica Neue", sans-serif;
            /* ä¿®æ­£ï¼šä½¿ç”¨å’Œ index.html ä¸€æ ·çš„æ¸å˜èƒŒæ™¯ï¼Œå¹¶ç¡®ä¿å§‹ç»ˆå¯è§ */
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            background-size: cover;
            color: #333;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
            /* ç¡®ä¿åœ¨æ‰‹æœºä¸Šä¹Ÿèƒ½çœ‹åˆ°æ¸å˜èƒŒæ™¯ */
            padding: 20px;
        }
        
        /* å®¹å™¨æ ·å¼ - ä¿®æ­£ï¼šä¸ index.html ä¿æŒä¸€è‡´ */
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            min-height: calc(100vh - 40px);
        }
        
        /* æ ‡é¢˜æ æ ·å¼ - ä¿®æ”¹ï¼šè®©"å¡«å†™è®¢å•ä¿¡æ¯"å±…ä¸­ */
        .header {
            background: white;
            padding: 20px 20px 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: center; /* å±…ä¸­ */
            margin-bottom: 10px;
            position: relative;
        }
        
        .back-btn {
            text-decoration: none;
            color: #666;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 5px;
            position: absolute;
            left: 0;
        }
        
        .back-btn span {
            font-size: 20px;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            text-align: center;
            margin: 0;
        }
        
        .header p {
            text-align: center;
            color: #999;
            font-size: 13px;
            font-weight: 300;
        }
        
        /* ä¸»ä½“å†…å®¹æ ·å¼ */
        .main-content {
            padding: 20px;
        }
        
        /* è¡¨å•åŒºåŸŸæ ·å¼ */
        .form-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-left: 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 15px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 400;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background: white;
            transition: border-color 0.2s;
        }
        
        .form-control:focus {
            border-color: #4d90fe;
            outline: none;
        }
        
        /* äº§å“å¡ç‰‡æ ·å¼ */
        .product-section {
            margin-bottom: 30px;
        }
        
        .product-card {
            background: white;
            border: 1px solid #f0f0f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
        }
        
        .product-card:hover {
            border-color: #4d90fe;
        }
        
        .product-name {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
        }
        
        .product-price {
            color: #ff6b6b;
            font-weight: 500;
            font-size: 15px;
            margin-bottom: 15px;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .quantity-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            font-size: 20px;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .quantity-btn:active {
            background: #f5f5f5;
            transform: scale(0.95);
        }
        
        .quantity-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .quantity-btn.minus {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }
        
        .quantity-btn.plus {
            border-color: #4CAF50;
            color: #4CAF50;
        }
        
        .quantity-input {
            flex: 1;
            text-align: center;
            padding: 8px 15px;
            font-size: 18px;
            font-weight: 600;
            border: none;
            background: transparent;
            color: #333;
        }
        
        .quantity-input:focus {
            outline: none;
        }
        
        /* è®¢å•æ±‡æ€»æ ·å¼ */
        .summary-section {
            background: white;
            border-radius: 12px;
            border: 1px solid #f0f0f0;
            padding: 20px;
            margin: 30px 0;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .summary-row:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            font-size: 16px;
            font-weight: 400;
            color: #333;
        }
        
        .summary-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        /* ä¿®æ­£ï¼šè®¢å•æ€»ä»·ç”¨çº¢è‰²å­—ä½“ */
        .summary-value.total-price {
            color: #ff6b6b;
            font-size: 20px;
        }
        
        /* é¢„è®¡æ—¶é—´æ ·å¼ */
        .time-estimate {
            background: white;
            border-radius: 12px;
            border: 1px solid #e9ecef;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .time-label {
            font-size: 16px;
            font-weight: 400;
            color: #333;
            margin-bottom: 8px;
        }
        
        .time-value {
            font-size: 24px;
            font-weight: 700;
            color: #ff6b6b;
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid rgba(255, 107, 107, 0.1);
            margin-bottom: 8px;
        }
        
        .finish-time {
            font-size: 16px;
            color: #4CAF50;
            text-align: center;
            font-weight: 500;
        }
        
        /* æäº¤æŒ‰é’®æ ·å¼ */
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 20px;
        }
        
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }
        
        .submit-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        /* æ¶ˆæ¯æç¤ºæ ·å¼ */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        
        .message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
            display: block;
        }
        
        .message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
            display: block;
        }
        
        /* åº•éƒ¨æ ·å¼ */
        .footer {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 12px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }
        
        /* æ‰‹æœºç«¯å“åº”å¼ä¼˜åŒ– - ç¡®ä¿åœ¨ä»»ä½•å®½åº¦éƒ½èƒ½çœ‹åˆ°èƒŒæ™¯ */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .container {
                width: 100%;
                min-height: calc(100vh - 30px);
                border-radius: 16px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                width: 100%;
                min-height: calc(100vh - 20px);
                border-radius: 12px;
            }
            
            .header {
                padding: 15px 20px 12px 20px;
            }
            
            .header h1 {
                font-size: 18px;
            }
            
            .back-btn {
                font-size: 15px;
            }
            
            .main-content {
                padding: 15px 12px;
            }
            
            .product-card {
                padding: 12px;
            }
            
            .quantity-btn {
                width: 32px;
                height: 32px;
            }
            
            .form-control {
                padding: 10px 12px;
                font-size: 15px;
            }
            
            .submit-btn {
                padding: 14px;
                font-size: 15px;
            }
            
            .time-value {
                font-size: 18px;
            }
        }
        
        @media (max-width: 360px) {
            body {
                padding: 8px;
            }
            
            .container {
                width: 100%;
                min-height: calc(100vh - 16px);
                border-radius: 10px;
            }
            
            .header h1 {
                font-size: 16px;
            }
            
            .header p {
                font-size: 12px;
            }
            
            .back-btn {
                font-size: 14px;
            }
        }
        
        /* è¾“å…¥æ¡†æ•°å­—è°ƒèŠ‚æŒ‰é’®éšè— */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* è§¦æ‘¸ä¼˜åŒ– */
        .touch-optimized {
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ç¡®ä¿èƒŒæ™¯å§‹ç»ˆå¯è§çš„é¢å¤–è®¾ç½® */
        html, body {
            min-height: 100%;
        }
        
        .container {
            /* ç¡®ä¿å®¹å™¨ä¸ä¼šå®Œå…¨è¦†ç›–èƒŒæ™¯ */
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="touch-optimized">
    <div class="container">
        <!-- æ ‡é¢˜æ  -->
        <div class="header">
            <div class="header-top">
                <!-- ä¿®æ”¹ï¼šè¿”å›æ’é˜Ÿä¿¡æ¯æ”¹æˆè¿”å› -->
                <a href="index.html" class="back-btn"><span>â€¹</span> è¿”å›</a>
                <h1>å¡«å†™è®¢å•ä¿¡æ¯</h1>
            </div>
            <p>å‡¤å‡°å·æ‰‹å·¥åŠ - åœ¨çº¿ä¸‹å•</p>
        </div>
        
        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- æ¶ˆæ¯æç¤º -->
            <div id="message" class="message" style="display: none;"></div>
            
            <!-- é¡¾å®¢ä¿¡æ¯ -->
            <div class="form-section">
                <h2 class="section-title">é¡¾å®¢ä¿¡æ¯</h2>
                
                <div class="form-group">
                    <label for="customerName">é¡¾å®¢å§“å</label>
                    <!-- ä¿®æ”¹ï¼šæ¸…ç©ºé»˜è®¤å€¼ -->
                    <input type="text" id="customerName" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" value="">
                </div>
                
                <div class="form-group">
                    <label for="phoneNumber">æ‰‹æœºå·ç </label>
                    <!-- ä¿®æ”¹ï¼šæ¸…ç©ºé»˜è®¤å€¼ -->
                    <input type="tel" id="phoneNumber" class="form-control" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·" value="" maxlength="11">
                </div>
            </div>
            
            <!-- äº§å“é€‰æ‹© -->
            <div class="product-section">
                <h2 class="section-title">è¯·é€‰æ‹©æ‚¨è¦è®¢è´­çš„äº§å“</h2>
                
                <!-- åŸå‘³è›‹å· -->
                <div class="product-card">
                    <div class="product-name">åŸå‘³è›‹å·</div>
                    <div class="product-price">12å…ƒ/ç›’</div>
                    <div class="quantity-control">
                        <button class="quantity-btn minus" onclick="changeQuantity('original', -1)">-</button>
                        <input type="number" id="originalQty" class="quantity-input" value="0" min="0" readonly>
                        <button class="quantity-btn plus" onclick="changeQuantity('original', 1)">+</button>
                    </div>
                </div>
                
                <!-- ç´«èœè‚‰æ¾å· -->
                <div class="product-card">
                    <div class="product-name">ç´«èœè‚‰æ¾å·</div>
                    <div class="product-price">12å…ƒ/ç›’</div>
                    <div class="quantity-control">
                        <button class="quantity-btn minus" onclick="changeQuantity('seaweed', -1)">-</button>
                        <input type="number" id="seaweedQty" class="quantity-input" value="0" min="0" readonly>
                        <button class="quantity-btn plus" onclick="changeQuantity('seaweed', 1)">+</button>
                    </div>
                </div>
                
                <!-- æ¤°è“‰æ¤°ä¸å· -->
                <div class="product-card">
                    <div class="product-name">æ¤°è“‰æ¤°ä¸å·</div>
                    <div class="product-price">12å…ƒ/ç›’</div>
                    <div class="quantity-control">
                        <button class="quantity-btn minus" onclick="changeQuantity('coconut', -1)">-</button>
                        <input type="number" id="coconutQty" class="quantity-input" value="0" min="0" readonly>
                        <button class="quantity-btn plus" onclick="changeQuantity('coconut', 1)">+</button>
                    </div>
                </div>
            </div>
            
            <!-- è®¢å•æ±‡æ€» -->
            <div class="summary-section">
                <div class="summary-row">
                    <div class="summary-label">æ€»ç›’æ•°</div>
                    <div id="totalBoxes" class="summary-value">0 ç›’</div>
                </div>
                <div class="summary-row">
                    <div class="summary-label">è®¢å•æ€»ä»·</div>
                    <div id="totalPrice" class="summary-value total-price">0 å…ƒ</div>
                </div>
            </div>
            
            <!-- é¢„è®¡æ—¶é—´ -->
            <div class="time-estimate">
                <div class="time-label">é¢„è®¡å®Œæˆæ—¶é—´</div>
                <div id="estimatedTime" class="time-value">è¯·å…ˆé€‰æ‹©äº§å“æ•°é‡</div>
                <div id="finishTime" class="finish-time"></div>
            </div>
            
            <!-- æäº¤æŒ‰é’® -->
            <button id="submitBtn" class="submit-btn" onclick="submitOrder()">æäº¤è®¢å•</button>
        </div>
        
        <div class="footer">
            <p>æ•°æ®å®æ—¶åŒæ­¥ Â© 2024 å‡¤å‡°å·æ‰‹å·¥åŠ</p>
        </div>
    </div>

    <script>
        // äº§å“æ•°æ®
        const PRODUCTS = {
            original: { name: "åŸå‘³è›‹å·", price: 12, quantity: 0 },
            seaweed: { name: "ç´«èœè‚‰æ¾å·", price: 12, quantity: 0 },
            coconut: { name: "æ¤°è“‰æ¤°ä¸å·", price: 12, quantity: 0 }
        };
        
        // è®¢å•æ•°æ®
        let orderData = {
            customerName: "",
            phoneNumber: "",
            pickupCode: "",
            estimatedFinishTime: ""
        };
        
        // ç»´æ ¼è¡¨é…ç½®
        const VIKA_CONFIG = {
            datasheetId: 'dstdZLRwtDlCi4AyKa',
            apiToken: 'uskLW8N76RCrShK1OZUpPEP',
            viewId: 'viwUP6lh3f5q2'
        };
        
        // ç”Ÿäº§é…ç½®
        const PRODUCTION_CONFIG = {
            minutesPerBox: 8.5,
            machines: 3,
            bufferTime: 2
        };
        
        // å–è´§ç è®¡æ•°å™¨ï¼ˆæ¨¡æ‹Ÿé€’å¢ï¼‰
        let pickupCodeCounter = 854; // ä»ç±»ä¼¼å›¾ç‰‡ä¸­çš„854å¼€å§‹
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åˆå§‹åŒ–...');
            
            // è®¾ç½®è¾“å…¥æ¡†äº‹ä»¶
            document.getElementById('customerName').addEventListener('input', function() {
                orderData.customerName = this.value;
                validateForm();
            });
            
            document.getElementById('phoneNumber').addEventListener('input', function() {
                orderData.phoneNumber = this.value;
                validateForm();
            });
            
            // æ›´æ–°æ•°é‡
            updateQuantities();
            
            // è®¡ç®—åˆå§‹æ—¶é—´å’Œæ€»ä»·
            calculateTotal();
            calculateEstimatedTime();
            
            // éªŒè¯è¡¨å•
            validateForm();
        });
        
        // æ”¹å˜æ•°é‡
        function changeQuantity(product, change) {
            const input = document.getElementById(product + 'Qty');
            const currentValue = parseInt(input.value) || 0;
            const newValue = Math.max(0, currentValue + change);
            
            input.value = newValue;
            PRODUCTS[product].quantity = newValue;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateButtonState(product, newValue);
            
            // é‡æ–°è®¡ç®—
            calculateTotal();
            calculateEstimatedTime();
            validateForm();
        }
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateButtonState(product, value) {
            const minusBtn = document.querySelector(`button.minus[onclick*="${product}"]`);
            if (minusBtn) {
                minusBtn.disabled = value <= 0;
            }
        }
        
        // æ›´æ–°æ•°é‡
        function updateQuantities() {
            Object.keys(PRODUCTS).forEach(product => {
                const input = document.getElementById(product + 'Qty');
                if (input) {
                    input.value = PRODUCTS[product].quantity;
                    updateButtonState(product, PRODUCTS[product].quantity);
                }
            });
        }
        
        // è®¡ç®—æ€»è®¡
        function calculateTotal() {
            let totalBoxes = 0;
            let totalPrice = 0;
            
            Object.keys(PRODUCTS).forEach(product => {
                const quantity = PRODUCTS[product].quantity;
                totalBoxes += quantity;
                totalPrice += quantity * PRODUCTS[product].price;
            });
            
            document.getElementById('totalBoxes').textContent = totalBoxes + ' ç›’';
            document.getElementById('totalPrice').textContent = totalPrice + ' å…ƒ';
            
            return { totalBoxes, totalPrice };
        }
        
        // è®¡ç®—é¢„è®¡æ—¶é—´
        async function calculateEstimatedTime() {
            const { totalBoxes } = calculateTotal();
            
            if (totalBoxes === 0) {
                document.getElementById('estimatedTime').textContent = "è¯·å…ˆé€‰æ‹©äº§å“æ•°é‡";
                document.getElementById('finishTime').textContent = "";
                return;
            }
            
            try {
                // è·å–å½“å‰æ’é˜Ÿæ•°æ®
                const queueData = await getQueueData();
                
                console.log('è·å–åˆ°çš„æ’é˜Ÿæ•°æ®:', queueData);
                
                if (queueData) {
                    const { minutesPerBox, machines, bufferTime } = PRODUCTION_CONFIG;
                    const queueBoxes = queueData.queueBoxes || 0;
                    
                    console.log(`æ’é˜Ÿç›’æ•°: ${queueBoxes}ç›’, æœ¬å•ç›’æ•°: ${totalBoxes}ç›’`);
                    
                    // è®¡ç®—æœ¬è®¢å•åˆ¶ä½œæ—¶é—´
                    const orderMinutes = Math.ceil((totalBoxes * minutesPerBox) / machines);
                    
                    // è®¡ç®—æ’é˜Ÿç­‰å¾…æ—¶é—´
                    const queueMinutes = Math.ceil((queueBoxes * minutesPerBox) / machines);
                    
                    // æ€»æ—¶é—´ = æ’é˜Ÿæ—¶é—´ + æœ¬è®¢å•åˆ¶ä½œæ—¶é—´ + ç¼“å†²æ—¶é—´
                    const totalMinutes = queueMinutes + orderMinutes + bufferTime;
                    
                    console.log(`æœ¬å•æ—¶é—´: ${orderMinutes}åˆ†é’Ÿ, æ’é˜Ÿæ—¶é—´: ${queueMinutes}åˆ†é’Ÿ, æ€»æ—¶é—´: ${totalMinutes}åˆ†é’Ÿ`);
                    
                    // è®¡ç®—é¢„è®¡å®Œæˆæ—¶é—´
                    const now = new Date();
                    const finishTime = new Date(now.getTime() + totalMinutes * 60000);
                    
                    // æ ¼å¼åŒ–æ˜¾ç¤º
                    const formattedTime = formatTime(finishTime);
                    
                    document.getElementById('estimatedTime').textContent = totalMinutes + ' åˆ†é’Ÿ';
                    document.getElementById('finishTime').textContent = 'é¢„è®¡å®Œæˆï¼š' + formattedTime;
                    
                    // ä¿å­˜åˆ°è®¢å•æ•°æ®
                    orderData.estimatedFinishTime = finishTime.toISOString();
                    
                } else {
                    // å¦‚æœè·å–æ’é˜Ÿæ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä¼°ç®—
                    console.log('è·å–æ’é˜Ÿæ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä¼°ç®—');
                    const { minutesPerBox, machines, bufferTime } = PRODUCTION_CONFIG;
                    const orderMinutes = Math.ceil((totalBoxes * minutesPerBox) / machines);
                    const totalMinutes = orderMinutes + bufferTime;
                    
                    const now = new Date();
                    const finishTime = new Date(now.getTime() + totalMinutes * 60000);
                    const formattedTime = formatTime(finishTime);
                    
                    document.getElementById('estimatedTime').textContent = totalMinutes + ' åˆ†é’Ÿ';
                    document.getElementById('finishTime').textContent = 'é¢„è®¡å®Œæˆï¼š' + formattedTime;
                    
                    orderData.estimatedFinishTime = finishTime.toISOString();
                }
            } catch (error) {
                console.error('è®¡ç®—é¢„è®¡æ—¶é—´å¤±è´¥:', error);
                document.getElementById('estimatedTime').textContent = "è®¡ç®—ä¸­...";
                document.getElementById('finishTime').textContent = "";
            }
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        // è·å–æ’é˜Ÿæ•°æ®
        async function getQueueData() {
            try {
                const response = await fetch(
                    `https://api.vika.cn/fusion/v1/datasheets/${VIKA_CONFIG.datasheetId}/records?viewId=${VIKA_CONFIG.viewId}&fieldKey=name`,
                    {
                        headers: {
                            'Authorization': `Bearer ${VIKA_CONFIG.apiToken}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success !== true) {
                    throw new Error(data.message || 'APIè¿”å›å¤±è´¥');
                }
                
                const orders = data.data?.records || [];
                let queueBoxes = 0;
                
                // è·å–ä»Šå¤©0ç‚¹çš„æ—¶é—´æˆ³
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStart = today.getTime();
                
                console.log(`ä»Šå¤©å¼€å§‹æ—¶é—´: ${new Date(todayStart).toLocaleString()}`);
                
                orders.forEach(order => {
                    const status = order.fields["çŠ¶æ€"] || 'æ’é˜Ÿä¸­';
                    const orderTime = order.fields["åˆ›å»ºæ—¶é—´"] || order.fields["è®°å½•åˆ›å»ºæ—¶é—´"] || 0;
                    
                    // åªç»Ÿè®¡ä»Šå¤©çš„æ’é˜Ÿä¸­è®¢å•
                    if (status === 'æ’é˜Ÿä¸­' && orderTime > todayStart) {
                        const originalQty = parseInt(order.fields["åŸå‘³æ•°é‡"] || 0);
                        const seaweedQty = parseInt(order.fields["ç´«èœæ•°é‡"] || 0);
                        const coconutQty = parseInt(order.fields["æ¤°è“‰æ•°é‡"] || 0);
                        const orderBoxes = originalQty + seaweedQty + coconutQty;
                        
                        console.log(`ä»Šæ—¥æ’é˜Ÿä¸­è®¢å•: ${originalQty}+${seaweedQty}+${coconutQty}=${orderBoxes}ç›’, æ—¶é—´: ${new Date(orderTime).toLocaleString()}`);
                        
                        queueBoxes += orderBoxes;
                    }
                });
                
                console.log(`å½“å¤©æ’é˜Ÿè®¢å•æ€»ç›’æ•°: ${queueBoxes}ç›’`);
                
                return { queueBoxes };
                
            } catch (error) {
                console.error('è·å–æ’é˜Ÿæ•°æ®å¤±è´¥:', error);
                return { queueBoxes: 0 };
            }
        }
        
        // ç”Ÿæˆå–è´§ç  - ä¿®æ”¹ä¸ºç±»ä¼¼"J-854"çš„æ ¼å¼
        function generatePickupCode() {
            // ä»A-Zä¸­éšæœºé€‰æ‹©ä¸€ä¸ªå­—æ¯
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            const randomLetter = letters[Math.floor(Math.random() * letters.length)];
            
            // ä»800-999ä¸­ç”Ÿæˆä¸‰ä½æ•°å­—ï¼ˆæ¨¡æ‹Ÿé€’å¢æ•ˆæœï¼‰
            // è¿™é‡Œä½¿ç”¨ä¸€ä¸ªè®¡æ•°å™¨ï¼Œæ¯æ¬¡é€’å¢1
            let numberPart = pickupCodeCounter.toString();
            
            // å¦‚æœæ˜¯æ•°å­—å°äº100ï¼Œå‰é¢è¡¥0
            if (pickupCodeCounter < 100) {
                numberPart = pickupCodeCounter.toString().padStart(3, '0');
            }
            
            // è®¡æ•°å™¨é€’å¢
            pickupCodeCounter++;
            
            // æ ¼å¼ï¼šå­—æ¯-æ•°å­—ï¼Œä¾‹å¦‚ "J-854"
            return `${randomLetter}-${numberPart}`;
        }
        
        // éªŒè¯è¡¨å•
        function validateForm() {
            const customerName = document.getElementById('customerName').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const { totalBoxes } = calculateTotal();
            
            const submitBtn = document.getElementById('submitBtn');
            
            // éªŒè¯æ¡ä»¶
            const isNameValid = customerName.length >= 2;
            const isPhoneValid = /^1[3-9]\d{9}$/.test(phoneNumber);
            const isProductValid = totalBoxes > 0;
            
            submitBtn.disabled = !(isNameValid && isPhoneValid && isProductValid);
            
            return isNameValid && isPhoneValid && isProductValid;
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            // æ»šåŠ¨åˆ°æ¶ˆæ¯ä½ç½®
            setTimeout(() => {
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
            
            // è‡ªåŠ¨éšè—
            if (type !== 'error') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // æäº¤è®¢å•
        async function submitOrder() {
            if (!validateForm()) {
                showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯å¹¶è‡³å°‘é€‰æ‹©ä¸€ç›’äº§å“', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const originalText = submitBtn.textContent;
            
            submitBtn.disabled = true;
            submitBtn.textContent = 'æäº¤ä¸­...';
            
            try {
                const customerName = document.getElementById('customerName').value.trim();
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                const { totalBoxes, totalPrice } = calculateTotal();
                
                const originalQty = parseInt(document.getElementById('originalQty').value) || 0;
                const seaweedQty = parseInt(document.getElementById('seaweedQty').value) || 0;
                const coconutQty = parseInt(document.getElementById('coconutQty').value) || 0;
                
                // ç”Ÿæˆå–è´§ç ï¼ˆä½¿ç”¨æ–°æ ¼å¼ï¼‰
                const pickupCode = generatePickupCode();
                
                // è®¡ç®—é¢„è®¡å®Œæˆæ—¶é—´
                const { minutesPerBox, machines, bufferTime } = PRODUCTION_CONFIG;
                const orderMinutes = Math.ceil((totalBoxes * minutesPerBox) / machines);
                
                // è·å–å½“å‰æ’é˜Ÿæ•°æ®
                const queueData = await getQueueData();
                const queueBoxes = queueData ? queueData.queueBoxes : 0;
                const queueMinutes = Math.ceil((queueBoxes * minutesPerBox) / machines);
                const totalMinutes = queueMinutes + orderMinutes + bufferTime;
                
                const now = new Date();
                const finishTime = new Date(now.getTime() + totalMinutes * 60000);
                
                console.log(`æäº¤è®¢å•: ${customerName}, æ‰‹æœº: ${phoneNumber}`);
                console.log(`æ•°é‡: åŸå‘³${originalQty}ç›’, ç´«èœ${seaweedQty}ç›’, æ¤°è“‰${coconutQty}ç›’, æ€»è®¡${totalBoxes}ç›’`);
                console.log(`ä»·æ ¼: ${totalPrice}å…ƒ, å–è´§ç : ${pickupCode}`);
                console.log(`é¢„è®¡æ—¶é—´: ç­‰å¾…${queueMinutes}åˆ†é’Ÿ + åˆ¶ä½œ${orderMinutes}åˆ†é’Ÿ + ç¼“å†²${bufferTime}åˆ†é’Ÿ = æ€»è®¡${totalMinutes}åˆ†é’Ÿ`);
                
                // å‡†å¤‡æäº¤æ•°æ®
                const orderData = {
                    records: [{
                        fields: {
                            "é¡¾å®¢å§“å": customerName,
                            "æ‰‹æœºå·ç ": phoneNumber,
                            "åŸå‘³æ•°é‡": originalQty,
                            "ç´«èœæ•°é‡": seaweedQty,
                            "æ¤°è“‰æ•°é‡": coconutQty,
                            "çŠ¶æ€": "æ’é˜Ÿä¸­",
                            "å–è´§ç ": pickupCode,
                            "# é¢„è®¡åˆ¶ä½œæ—¶": orderMinutes,
                            "é¢„è®¡å®Œæˆæ—¶é—´": finishTime.toISOString(),
                            "# æ€»ç›’æ•°": totalBoxes,
                            "è®¢å•æ€»ä»·": totalPrice
                        }
                    }]
                };
                
                console.log('æäº¤è®¢å•æ•°æ®:', orderData);
                
                // æäº¤åˆ°ç»´æ ¼è¡¨
                const response = await fetch(
                    `https://api.vika.cn/fusion/v1/datasheets/${VIKA_CONFIG.datasheetId}/records`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${VIKA_CONFIG.apiToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(orderData)
                    }
                );
                
                const data = await response.json();
                console.log('APIå“åº”:', data);
                
                if (response.ok && data.success) {
                    showMessage('ğŸ‰ è®¢å•æäº¤æˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                    
                    // ä¿å­˜è®¢å•ä¿¡æ¯
                    const orderInfo = {
                        customerName,
                        phoneNumber,
                        originalQty,
                        seaweedQty,
                        coconutQty,
                        totalBoxes,
                        totalPrice,
                        pickupCode,
                        estimatedTime: totalMinutes + ' åˆ†é’Ÿ',
                        finishTime: formatTime(finishTime),
                        orderTime: new Date().toLocaleString('zh-CN')
                    };
                    
                    localStorage.setItem('lastOrder', JSON.stringify(orderInfo));
                    
                    // å»¶è¿Ÿè·³è½¬åˆ°æˆåŠŸé¡µé¢
                    setTimeout(() => {
                        window.location.href = 'success.html';
                    }, 2000);
                    
                } else {
                    // å°è¯•ç®€åŒ–ç‰ˆæœ¬
                    console.log('å°è¯•ç®€åŒ–ç‰ˆæœ¬...');
                    const simplifiedOrderData = {
                        records: [{
                            fields: {
                                "é¡¾å®¢å§“å": customerName,
                                "æ‰‹æœºå·ç ": phoneNumber,
                                "åŸå‘³æ•°é‡": originalQty,
                                "ç´«èœæ•°é‡": seaweedQty,
                                "æ¤°è“‰æ•°é‡": coconutQty,
                                "çŠ¶æ€": "æ’é˜Ÿä¸­",
                                "å–è´§ç ": pickupCode
                            }
                        }]
                    };
                    
                    const retryResponse = await fetch(
                        `https://api.vika.cn/fusion/v1/datasheets/${VIKA_CONFIG.datasheetId}/records`,
                        {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${VIKA_CONFIG.apiToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(simplifiedOrderData)
                        }
                    );
                    
                    const retryData = await retryResponse.json();
                    
                    if (retryResponse.ok && retryData.success) {
                        showMessage('ğŸ‰ è®¢å•æäº¤æˆåŠŸï¼æ­£åœ¨è·³è½¬...', 'success');
                        
                        const orderInfo = {
                            customerName,
                            phoneNumber,
                            originalQty,
                            seaweedQty,
                            coconutQty,
                            totalBoxes,
                            totalPrice,
                            pickupCode,
                            estimatedTime: totalMinutes + ' åˆ†é’Ÿ',
                            finishTime: formatTime(finishTime),
                            orderTime: new Date().toLocaleString('zh-CN')
                        };
                        
                        localStorage.setItem('lastOrder', JSON.stringify(orderInfo));
                        
                        setTimeout(() => {
                            window.location.href = 'success.html';
                        }, 2000);
                        
                    } else {
                        throw new Error(retryData.message || 'æäº¤å¤±è´¥');
                    }
                }
                
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                showMessage(`âŒ æäº¤å¤±è´¥: ${error.message || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'}`, 'error');
                
                // æ¢å¤æŒ‰é’®
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }
    </script>
</body>
</html>