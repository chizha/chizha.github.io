<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>å¡«å†™è®¢å•ä¿¡æ¯ - é¸¡è›‹å·æ‰‹å·¥åŠ</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body { 
            font-family: "PingFang SC", "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255,255,255,0.98);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(0,0,0,0.08);
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 1.6em;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1em;
        }
        
        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.9);
            border: 1px solid rgba(0,0,0,0.1);
            border-radius: 8px;
            text-decoration: none;
            color: #2c3e50;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .back-btn:hover {
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
            font-size: 0.95em;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
            background: white;
        }
        
        .form-control:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        /* äº§å“é€‰æ‹© */
        .products-section {
            margin-bottom: 25px;
        }
        
        .product-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .product-item:hover {
            border-color: #3498db;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.1);
        }
        
        .product-name {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .product-price {
            color: #e74c3c;
            font-weight: 600;
            font-size: 1em;
            margin-bottom: 15px;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .quantity-btn:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }
        
        .quantity-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .quantity-input {
            flex: 1;
            text-align: center;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 8px;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .quantity-input:read-only {
            background: #f8f9fa;
            cursor: default;
        }
        
        /* è®¢å•æ±‡æ€» */
        .summary-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #f1f3f5 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .summary-item:last-child {
            border-bottom: none;
        }
        
        .summary-label {
            color: #7f8c8d;
            font-weight: 500;
        }
        
        .summary-value {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .total-price {
            color: #e74c3c;
            font-size: 1.2em;
            font-weight: 700;
        }
        
        /* æ—¶é—´ä¼°ç®— */
        .time-estimate {
            background: linear-gradient(135deg, #fff8e1 0%, #ffeaa7 100%);
            border: 1px solid #ffd54f;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 25px;
        }
        
        .time-estimate h4 {
            color: #d84315;
            margin-bottom: 10px;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .estimated-time {
            font-size: 1.5em;
            font-weight: 800;
            color: #e74c3c;
            margin: 10px 0;
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid rgba(231, 76, 60, 0.2);
        }
        
        /* æŒ‰é’® */
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #27ae60 0%, #219653 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }
        
        .submit-btn:active {
            transform: translateY(0);
        }
        
        .submit-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* æ¶ˆæ¯æç¤º */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 0.9em;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .message.success {
            background: #d1e7dd;
            color: #0f5132;
            border: 1px solid #badbcc;
        }
        
        /* å“åº”å¼è®¾è®¡ - æ‰‹æœºç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            .container {
                padding: 20px 15px;
                border-radius: 16px;
                max-width: 100%;
                margin: 0 auto 20px;
            }
            
            .header {
                margin-bottom: 20px;
                padding-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.4em;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .back-btn {
                top: 15px;
                left: 15px;
                padding: 6px 12px;
                font-size: 0.85em;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .product-item {
                padding: 15px;
                margin-bottom: 12px;
            }
            
            .product-name {
                font-size: 1em;
            }
            
            .product-price {
                font-size: 0.95em;
                margin-bottom: 12px;
            }
            
            .quantity-btn {
                width: 36px;
                height: 36px;
                font-size: 1.1em;
            }
            
            .quantity-input {
                font-size: 1em;
            }
            
            .summary-section {
                padding: 15px;
                margin: 20px 0;
            }
            
            .estimated-time {
                font-size: 1.3em;
                padding: 8px;
            }
            
            .submit-btn {
                padding: 14px;
                font-size: 1em;
                border-radius: 8px;
            }
        }
        
        /* å°å±å¹•æ‰‹æœºä¼˜åŒ– */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px 12px;
                border-radius: 14px;
            }
            
            .header h1 {
                font-size: 1.3em;
            }
            
            .product-item {
                padding: 12px;
            }
            
            .quantity-btn {
                width: 32px;
                height: 32px;
            }
            
            .quantity-input {
                font-size: 0.95em;
            }
            
            .submit-btn {
                padding: 12px;
                font-size: 0.95em;
            }
        }
        
        /* å¹³æ¿å’Œæ¡Œé¢ä¼˜åŒ– */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 600px;
            }
        }
        
        /* é˜²æ­¢é•¿æŒ‰èœå• */
        .no-select {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* ä¼˜åŒ–è§¦æ‘¸ä½“éªŒ */
        .touch-optimized {
            -webkit-tap-highlight-color: transparent;
        }
        
        /* æ»šåŠ¨ä¼˜åŒ– */
        html {
            scroll-behavior: smooth;
        }
        
        /* è¡¨å•éªŒè¯æ ·å¼ */
        .form-control.error {
            border-color: #e74c3c;
            background-color: #fdf2f2;
        }
        
        .form-control.valid {
            border-color: #27ae60;
        }
        
        /* äº§å“å›¾ç‰‡å ä½ç¬¦ */
        .product-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
        }
        
        /* è®¢å•å·æ˜¾ç¤º */
        .order-number {
            text-align: center;
            padding: 10px;
            background: #f1f8ff;
            border-radius: 8px;
            border: 1px solid #c8e1ff;
            margin: 20px 0;
        }
        
        .order-number .label {
            color: #7f8c8d;
            font-size: 0.9em;
        }
        
        .order-number .value {
            font-size: 1.2em;
            font-weight: 700;
            color: #0366d6;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <div class="container no-select touch-optimized">
        <a href="index.html" class="back-btn"><è¿”å›</a>
        
        <div class="header">
            <h1>å¡«å†™è®¢å•ä¿¡æ¯</h1>
            <p>é¸¡è›‹å·æ‰‹å·¥åŠ - åœ¨çº¿ä¸‹å•</p>
        </div>
        
        <!-- æ¶ˆæ¯æç¤ºåŒºåŸŸ -->
        <div id="messageContainer" style="display: none;" class="message"></div>
        
        <!-- é¡¾å®¢ä¿¡æ¯ -->
        <div class="form-group">
            <label for="customerName">é¡¾å®¢å§“å</label>
            <input type="text" id="customerName" class="form-control" placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å" maxlength="20">
        </div>
        
        <div class="form-group">
            <label for="phoneNumber">æ‰‹æœºå·ç </label>
            <input type="tel" id="phoneNumber" class="form-control" placeholder="è¯·è¾“å…¥11ä½æ‰‹æœºå·" maxlength="11">
        </div>
        
        <!-- äº§å“é€‰æ‹© -->
        <div class="products-section">
            <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.1em;">è¯·é€‰æ‹©æ‚¨è¦è®¢è´­çš„äº§å“</h3>
            
            <!-- åŸå‘³è›‹å· -->
            <div class="product-item">
                <div class="product-name">åŸå‘³è›‹å·</div>
                <div class="product-price">12å…ƒ/ç›’</div>
                <div class="quantity-control">
                    <button class="quantity-btn minus" data-product="original" disabled>-</button>
                    <input type="number" id="originalQty" class="quantity-input" value="0" readonly>
                    <button class="quantity-btn plus" data-product="original">+</button>
                </div>
            </div>
            
            <!-- ç´«èœè‚‰æ¾ -->
            <div class="product-item">
                <div class="product-name">ç´«èœè‚‰æ¾å‡¤å‡°å·</div>
                <div class="product-price">12å…ƒ/ç›’</div>
                <div class="quantity-control">
                    <button class="quantity-btn minus" data-product="seaweed" disabled>-</button>
                    <input type="number" id="seaweedQty" class="quantity-input" value="0" readonly>
                    <button class="quantity-btn plus" data-product="seaweed">+</button>
                </div>
            </div>
            
            <!-- æ¤°è“‰æ¤°ä¸ -->
            <div class="product-item">
                <div class="product-name">æ¤°è“‰æ¤°ä¸å‡¤å‡°å·</div>
                <div class="product-price">12å…ƒ/ç›’</div>
                <div class="quantity-control">
                    <button class="quantity-btn minus" data-product="coconut" disabled>-</button>
                    <input type="number" id="coconutQty" class="quantity-input" value="0" readonly>
                    <button class="quantity-btn plus" data-product="coconut">+</button>
                </div>
            </div>
        </div>
        
        <!-- è®¢å•æ±‡æ€» -->
        <div class="summary-section">
            <div class="summary-item">
                <div class="summary-label">æ€»ç›’æ•°</div>
                <div id="totalBoxes" class="summary-value">0 ç›’</div>
            </div>
            <div class="summary-item">
                <div class="summary-label">è®¢å•æ€»ä»·</div>
                <div id="totalPrice" class="summary-value total-price">0 å…ƒ</div>
            </div>
        </div>
        
        <!-- æ—¶é—´ä¼°ç®— -->
        <div class="time-estimate">
            <h4>â° é¢„è®¡å®Œæˆæ—¶é—´</h4>
            <div id="estimatedTimeDisplay" class="estimated-time">è¯·å…ˆé€‰æ‹©äº§å“æ•°é‡</div>
            <p style="color: #7f8c8d; font-size: 0.85em; text-align: center; margin-top: 8px;">
                åŸºäºå½“å‰æ’é˜Ÿæƒ…å†µå’Œåˆ¶ä½œé€Ÿåº¦ä¼°ç®—
            </p>
        </div>
        
        <!-- è®¢å•å·æ˜¾ç¤º -->
        <div id="orderNumberDisplay" class="order-number" style="display: none;">
            <div class="label">æ‚¨çš„è®¢å•å·ï¼š</div>
            <div id="orderNumber" class="value">0000000000</div>
        </div>
        
        <!-- æäº¤æŒ‰é’® -->
        <button id="submitBtn" class="submit-btn" disabled>
            <span>ğŸ“‹ æäº¤è®¢å•</span>
        </button>
        
        <!-- åº•éƒ¨è¯´æ˜ -->
        <div style="margin-top: 20px; text-align: center; color: #7f8c8d; font-size: 0.8em; padding: 10px;">
            <p>æ¸©é¦¨æç¤ºï¼šè®¢å•æäº¤åè¯·æŸ¥çœ‹æ’é˜Ÿä¿¡æ¯é¡µé¢</p>
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const VIKA_CONFIG = {
            datasheetId: 'dstdZLRwtDlCi4AyKa',
            apiToken: 'uskLW8N76RCrShK1OZUpPEP',
            viewId: 'viwUP6lh3f5q2'
        };
        
        // äº§å“ä¿¡æ¯
        const PRODUCTS = {
            original: { name: "åŸå‘³è›‹å·", price: 12, quantity: 0, element: null },
            seaweed: { name: "ç´«èœè‚‰æ¾", price: 12, quantity: 0, element: null },
            coconut: { name: "æ¤°è“‰æ¤°ä¸", price: 12, quantity: 0, element: null }
        };
        
        // åˆ¶ä½œå‚æ•°
        const PRODUCTION_CONFIG = {
            avgMinutesPerBox: 8.5,
            machines: 3
        };
        
        // å½“å‰æ’é˜Ÿæ•°æ®
        let queueData = {
            queueCount: 0,
            makingCount: 0,
            queueBoxes: 0
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('order.html åˆå§‹åŒ–...');
            
            // åˆå§‹åŒ–äº§å“å…ƒç´ 
            PRODUCTS.original.element = document.getElementById('originalQty');
            PRODUCTS.seaweed.element = document.getElementById('seaweedQty');
            PRODUCTS.coconut.element = document.getElementById('coconutQty');
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.quantity-btn.plus').forEach(btn => {
                btn.addEventListener('click', function() {
                    const product = this.getAttribute('data-product');
                    increaseQuantity(product);
                });
            });
            
            document.querySelectorAll('.quantity-btn.minus').forEach(btn => {
                btn.addEventListener('click', function() {
                    const product = this.getAttribute('data-product');
                    decreaseQuantity(product);
                });
            });
            
            // ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
            document.getElementById('customerName').addEventListener('input', validateForm);
            document.getElementById('phoneNumber').addEventListener('input', validateForm);
            
            // ç»‘å®šæäº¤æŒ‰é’®äº‹ä»¶
            document.getElementById('submitBtn').addEventListener('click', submitOrder);
            
            // åŠ è½½å½“å‰æ’é˜Ÿæ•°æ®ç”¨äºæ—¶é—´ä¼°ç®—
            loadQueueData();
            
            // åˆå§‹è¡¨å•éªŒè¯
            validateForm();
            
            // æ·»åŠ è¡¨å•éªŒè¯æ ·å¼
            addFormValidation();
        });
        
        // æ·»åŠ è¡¨å•éªŒè¯æ ·å¼
        function addFormValidation() {
            const nameInput = document.getElementById('customerName');
            const phoneInput = document.getElementById('phoneNumber');
            
            nameInput.addEventListener('blur', function() {
                if (this.value.trim()) {
                    this.classList.remove('error');
                    this.classList.add('valid');
                } else {
                    this.classList.remove('valid');
                }
            });
            
            phoneInput.addEventListener('blur', function() {
                if (isValidPhone(this.value)) {
                    this.classList.remove('error');
                    this.classList.add('valid');
                } else if (this.value.trim()) {
                    this.classList.remove('valid');
                    this.classList.add('error');
                } else {
                    this.classList.remove('valid', 'error');
                }
            });
        }
        
        // å¢åŠ æ•°é‡
        function increaseQuantity(product) {
            PRODUCTS[product].quantity++;
            PRODUCTS[product].element.value = PRODUCTS[product].quantity;
            updateUI();
        }
        
        // å‡å°‘æ•°é‡
        function decreaseQuantity(product) {
            if (PRODUCTS[product].quantity > 0) {
                PRODUCTS[product].quantity--;
                PRODUCTS[product].element.value = PRODUCTS[product].quantity;
                updateUI();
            }
        }
        
        // æ›´æ–°ç•Œé¢
        function updateUI() {
            // æ›´æ–°åŠ å‡æŒ‰é’®çŠ¶æ€
            Object.keys(PRODUCTS).forEach(product => {
                const minusBtn = document.querySelector(`.quantity-btn.minus[data-product="${product}"]`);
                minusBtn.disabled = PRODUCTS[product].quantity === 0;
            });
            
            // è®¡ç®—æ€»æ•°å’Œæ€»ä»·
            let totalBoxes = 0;
            let totalPrice = 0;
            
            Object.keys(PRODUCTS).forEach(product => {
                const quantity = PRODUCTS[product].quantity;
                totalBoxes += quantity;
                totalPrice += quantity * PRODUCTS[product].price;
            });
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('totalBoxes').textContent = `${totalBoxes} ç›’`;
            document.getElementById('totalPrice').textContent = `${totalPrice} å…ƒ`;
            
            // æ›´æ–°é¢„è®¡æ—¶é—´
            updateEstimatedTime(totalBoxes);
            
            // éªŒè¯è¡¨å•
            validateForm();
        }
        
        // æ›´æ–°é¢„è®¡æ—¶é—´
        function updateEstimatedTime(totalBoxes) {
            const timeDisplay = document.getElementById('estimatedTimeDisplay');
            
            if (totalBoxes === 0) {
                timeDisplay.textContent = "è¯·å…ˆé€‰æ‹©äº§å“æ•°é‡";
                timeDisplay.style.fontSize = "1em";
                timeDisplay.style.color = "#7f8c8d";
                return;
            }
            
            // è®¡ç®—ç­‰å¾…æ—¶é—´
            const queueMinutes = queueData.queueBoxes * PRODUCTION_CONFIG.avgMinutesPerBox / PRODUCTION_CONFIG.machines;
            const newOrderMinutes = totalBoxes * PRODUCTION_CONFIG.avgMinutesPerBox / PRODUCTION_CONFIG.machines;
            const totalMinutes = Math.ceil(queueMinutes + newOrderMinutes);
            
            timeDisplay.textContent = `${totalMinutes} åˆ†é’Ÿ`;
            timeDisplay.style.fontSize = "1.5em";
            timeDisplay.style.color = "#e74c3c";
        }
        
        // åŠ è½½æ’é˜Ÿæ•°æ®
        async function loadQueueData() {
            try {
                const response = await fetch(
                    `https://api.vika.cn/fusion/v1/datasheets/${VIKA_CONFIG.datasheetId}/records?viewId=${VIKA_CONFIG.viewId}&fieldKey=name`,
                    {
                        headers: {
                            'Authorization': `Bearer ${VIKA_CONFIG.apiToken}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                const data = await response.json();
                
                if (response.ok && data.success === true) {
                    const orders = data.data?.records || [];
                    let queueBoxes = 0;
                    
                    orders.forEach(order => {
                        const status = order.fields["çŠ¶æ€"] || 'æ’é˜Ÿä¸­';
                        if (status === 'æ’é˜Ÿä¸­' || status === 'åˆ¶ä½œä¸­') {
                            const originalQty = parseInt(order.fields["åŸå‘³æ•°é‡"]) || 0;
                            const seaweedQty = parseInt(order.fields["ç´«èœæ•°é‡"]) || 0;
                            const coconutQty = parseInt(order.fields["æ¤°è“‰æ•°é‡"]) || 0;
                            queueBoxes += originalQty + seaweedQty + coconutQty;
                        }
                    });
                    
                    queueData.queueBoxes = queueBoxes;
                    updateEstimatedTime(getTotalBoxes());
                }
            } catch (error) {
                console.error('åŠ è½½æ’é˜Ÿæ•°æ®å¤±è´¥:', error);
            }
        }
        
        // è·å–æ€»ç›’æ•°
        function getTotalBoxes() {
            return Object.keys(PRODUCTS).reduce((total, product) => {
                return total + PRODUCTS[product].quantity;
            }, 0);
        }
        
        // éªŒè¯è¡¨å•
        function validateForm() {
            const customerName = document.getElementById('customerName').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const totalBoxes = getTotalBoxes();
            
            const isValid = customerName.length >= 2 && 
                          isValidPhone(phoneNumber) && 
                          totalBoxes > 0;
            
            document.getElementById('submitBtn').disabled = !isValid;
            return isValid;
        }
        
        // éªŒè¯æ‰‹æœºå·
        function isValidPhone(phone) {
            return /^1[3-9]\d{9}$/.test(phone);
        }
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.textContent = message;
            messageContainer.className = `message ${type}`;
            messageContainer.style.display = 'block';
            
            // å¦‚æœæ˜¯é”™è¯¯æ¶ˆæ¯ï¼Œ3ç§’åè‡ªåŠ¨éšè—
            if (type === 'error') {
                setTimeout(() => {
                    messageContainer.style.display = 'none';
                }, 3000);
            }
        }
        
        // ç”Ÿæˆè®¢å•å·
        function generateOrderNumber() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            return `${year}${month}${day}${random}`;
        }
        
        // æäº¤è®¢å•
        async function submitOrder() {
            if (!validateForm()) {
                showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯å¹¶è‡³å°‘é€‰æ‹©ä¸€ç›’äº§å“', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>â³ æäº¤ä¸­...</span>';
            
            try {
                const customerName = document.getElementById('customerName').value.trim();
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                const orderNumber = generateOrderNumber();
                
                const orderData = {
                    records: [{
                        fields: {
                            "é¡¾å®¢å§“å": customerName,
                            "æ‰‹æœºå·": phoneNumber,
                            "åŸå‘³æ•°é‡": PRODUCTS.original.quantity.toString(),
                            "ç´«èœæ•°é‡": PRODUCTS.seaweed.quantity.toString(),
                            "æ¤°è“‰æ•°é‡": PRODUCTS.coconut.quantity.toString(),
                            "è®¢å•ç¼–å·": orderNumber,
                            "çŠ¶æ€": "æ’é˜Ÿä¸­",
                            "æäº¤æ—¶é—´": new Date().toISOString(),
                            "è®¢å•æ€»ä»·": (getTotalBoxes() * 12).toString()
                        }
                    }]
                };
                
                const response = await fetch(
                    `https://api.vika.cn/fusion/v1/datasheets/${VIKA_CONFIG.datasheetId}/records`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${VIKA_CONFIG.apiToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(orderData)
                    }
                );
                
                const data = await response.json();
                
                if (response.ok && data.success === true) {
                    // æ˜¾ç¤ºè®¢å•å·
                    document.getElementById('orderNumber').textContent = orderNumber;
                    document.getElementById('orderNumberDisplay').style.display = 'block';
                    
                    showMessage('ğŸ‰ è®¢å•æäº¤æˆåŠŸï¼', 'success');
                    
                    // 3ç§’åè·³è½¬åˆ°æˆåŠŸé¡µé¢
                    setTimeout(() => {
                        window.location.href = `success.html?orderNumber=${orderNumber}&name=${encodeURIComponent(customerName)}&phone=${phoneNumber}`;
                    }, 2000);
                    
                } else {
                    throw new Error(data.message || 'æäº¤å¤±è´¥');
                }
                
            } catch (error) {
                console.error('æäº¤è®¢å•å¤±è´¥:', error);
                showMessage('æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span>ğŸ“‹ æäº¤è®¢å•</span>';
            }
        }
    </script>
</body>
</html>